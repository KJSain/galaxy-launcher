---
# Copyright 2017 Sequencing Analysis Support Core - Leiden University Medical Center
# Contact us at: sasc@lumc.nl
#
# This file is part of galaxy-docker-ansible.
# A dual licensing mode is applied.
# The source code within this project is freely available for non-commercial use under the GNU Affero General Public license.
# For commercial users or users who do not want to follow the AGPL, please contact us to obtain a separate license.
#
# You should have received a copy of the GNU Affero General Public License along with this program. If not, see <http://www.gnu.org/licenses/>.

# General preinstall for all distro's

- name: Create docker default location
  file:
    state: directory
    path: "{{ docker_default_location }}"

- name: Set symbolic link for default location
  file:
    state: link
    path: /var/lib/docker
    src: "{{ docker_default_location }}"
  when: "not docker_default_location=='/var/lib/docker'"

# Distrospecific. Only disto.
# ansible_distribution_version specific things should be handled down the line
- include: "installdocker/{{ansible_distribution}}.yml"

# General postinstall
- name: install required python_packages
  package:
    name: "{{python_packages}}"
    state: latest

- name: Install required PIP packages
  pip:
    name: "{{ pip_packages }}"
    state: latest

- name: start docker service
  service:
    name: docker
    enabled: yes
    state: started

- name: test docker service
  command: docker run hello-world
  register: result
  until: '"Hello from Docker!" in result.stdout'
  retries: 10
  delay: 10
